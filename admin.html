<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중랑마을넷 관리자</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        /* 에디터 높이 설정 */
        .ql-editor { min-height: 300px; font-family: 'Noto Sans KR', sans-serif; font-size: 1rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="max-w-4xl mx-auto px-4 py-12">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">중랑마을넷 소식 관리</h1>
            <div class="flex items-center gap-4">
                <div id="auth-status" class="px-3 py-1 rounded-full bg-gray-200 text-gray-500 text-sm font-bold flex items-center">
                    <div class="w-2 h-2 rounded-full bg-gray-400 mr-2"></div>
                    연결 대기중...
                </div>
                <a href="index.html" class="text-green-600 hover:text-green-700 font-bold">홈페이지로 이동 <i class="fas fa-arrow-right"></i></a>
            </div>
        </div>

        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
            <p class="text-sm text-yellow-700">
                <i class="fas fa-info-circle mr-1"></i>
                이미지는 자동으로 압축되어 저장됩니다. (무료 버전 용량 제한: 글 하나당 약 1MB)
            </p>
        </div>

        <!-- 글 작성/수정 폼 -->
        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 mb-12 relative">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h2 id="form-title" class="text-xl font-bold">새 소식 작성</h2>
                <button id="cancel-edit-btn" class="hidden text-sm text-gray-500 hover:text-gray-700 font-bold px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 transition">
                    <i class="fas fa-times mr-1"></i>수정 취소
                </button>
            </div>
            
            <form id="newsForm" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">카테고리</label>
                        <select id="category" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="notice">공지사항</option>
                            <option value="market">중랑마을,장(場)</option>
                            <option value="network">네트워크 및 연대</option>
                            <option value="operation">위탁운영</option>
                            <option value="support">활동가 지원</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">날짜</label>
                        <input type="date" id="date" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">제목</label>
                    <input type="text" id="title" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="소식 제목을 입력하세요" required>
                </div>
                
                <!-- 이미지 파일 업로더 -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">대표 이미지 (썸네일)</label>
                    <div class="flex items-center space-x-4">
                        <input type="file" id="mainImageFile" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                    </div>
                    <p id="image-help-text" class="text-xs text-gray-400 mt-1">* 파일을 선택하면 자동으로 압축됩니다.</p>
                    <p id="current-image-status" class="text-xs text-blue-600 mt-1 font-bold hidden">※ 현재 등록된 이미지가 유지됩니다. 변경하려면 파일을 선택하세요.</p>
                </div>

                <!-- Quill Editor -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">본문 내용</label>
                    <div id="editor-container" class="bg-white border rounded-lg"></div>
                    <p class="text-xs text-gray-400 mt-1">* 툴바의 이미지 아이콘을 눌러 본문 사이에 이미지를 넣을 수 있습니다.</p>
                </div>

                <button type="submit" id="submit-btn" class="w-full bg-gray-400 text-white font-bold py-3 rounded-lg transition cursor-not-allowed" disabled>
                    연결 중...
                </button>
            </form>
        </div>

        <!-- 작성된 글 목록 -->
        <h2 class="text-xl font-bold mb-4">등록된 소식 목록</h2>
        <div id="admin-news-list" class="space-y-4">
            <div class="text-center py-10 text-gray-500">데이터를 불러오는 중...</div>
        </div>
    </div>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        
        if (typeof __firebase_config !== 'undefined') {
            // 1. Canvas 환경 (자동 설정)
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // 2. GitHub 배포용 설정 (본인의 키를 입력하세요)
            firebaseConfig = {
                apiKey: "AIzaSyAlGFAgrJLCz1Xno3lDwRaTONPhsXBujOM",
                authDomain: "jrmaeulnet-5021b.firebaseapp.com",
                projectId: "jrmaeulnet-5021b",
                storageBucket: "jrmaeulnet-5021b.firebasestorage.app",
                messagingSenderId: "48501741158",
                appId: "1:48501741158:web:37131a2bb6b02137bd7fa7",
                measurementId: "G-81GTM29VF7"
            };
        }

        // App ID 설정
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'jungnang-maeul-net';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 수정 모드 상태 관리 ---
        let isEditing = false;
        let currentEditId = null;
        let currentOriginalImage = null;
        let loadedPosts = {}; // ID로 데이터를 쉽게 찾기 위해 저장

        // --- 이미지 압축 로직 ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        resolve(dataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- Quill 에디터 설정 ---
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        // Quill 이미지 핸들러
        const imageHandler = () => {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (file) {
                    try {
                        const compressedDataUrl = await compressImage(file);
                        const range = quill.getSelection();
                        quill.insertEmbed(range.index, 'image', compressedDataUrl);
                    } catch (error) {
                        console.error('Image processing failed:', error);
                        alert('이미지 처리에 실패했습니다.');
                    }
                }
            };
        };
        quill.getModule('toolbar').addHandler('image', imageHandler);


        // --- Auth & Logic ---
        const authStatus = document.getElementById('auth-status');
        const submitBtn = document.getElementById('submit-btn');
        const newsForm = document.getElementById('newsForm');
        const newsList = document.getElementById('admin-news-list');
        const formTitle = document.getElementById('form-title');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const imageHelpText = document.getElementById('image-help-text');
        const currentImageStatus = document.getElementById('current-image-status');

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                authStatus.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>연결 실패`;
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authStatus.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>관리자 연결됨`;
                authStatus.classList.replace('bg-gray-200', 'bg-green-100');
                authStatus.classList.replace('text-gray-500', 'text-green-700');
                
                if (!isEditing) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    submitBtn.innerText = '등록하기';
                }

                loadNews();
            }
        });

        // 1. 글 등록 및 수정 (Submit Handler)
        newsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser) return alert('관리자 연결이 필요합니다.');

            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const date = document.getElementById('date').value;
            const mainImageFile = document.getElementById('mainImageFile').files[0];
            const content = quill.root.innerHTML;

            if (!title || !date || !content) return alert('필수 항목을 입력해주세요.');

            submitBtn.innerText = isEditing ? '수정 중...' : '저장 중...';
            submitBtn.disabled = true;

            try {
                let imageUrl = '';
                
                // 이미지를 새로 올렸으면 압축해서 사용
                if (mainImageFile) {
                    imageUrl = await compressImage(mainImageFile);
                } 
                // 새로 안 올렸는데 수정 모드라면 기존 이미지 유지
                else if (isEditing && currentOriginalImage) {
                    imageUrl = currentOriginalImage;
                }
                // 새로 쓰는 글인데 이미지 없으면 빈값
                else {
                    imageUrl = ''; 
                }

                // 용량 체크
                const docSize = new Blob([content + imageUrl]).size;
                if(docSize > 950000) { 
                    throw new Error("글 내용이나 이미지가 너무 큽니다. (제한 1MB)");
                }

                const postData = {
                    title, category, date, imageUrl, content,
                    updatedAt: new Date().toISOString()
                };

                if (!isEditing) {
                    postData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'news'), postData);
                    alert('등록 완료!');
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'news', currentEditId), postData);
                    alert('수정 완료!');
                    resetForm(); // 수정 후 초기화
                }

                if (!isEditing) {
                    resetForm();
                }
            } catch (error) {
                console.error("Error:", error);
                alert('처리 실패: ' + error.message);
            } finally {
                if (!isEditing) {
                    submitBtn.innerText = '등록하기';
                    submitBtn.disabled = false;
                }
            }
        });

        // 폼 초기화 함수
        function resetForm() {
            isEditing = false;
            currentEditId = null;
            currentOriginalImage = null;
            
            newsForm.reset();
            quill.setContents([]);
            
            formTitle.innerText = '새 소식 작성';
            submitBtn.innerText = '등록하기';
            submitBtn.classList.replace('bg-blue-600', 'bg-green-600');
            submitBtn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
            submitBtn.disabled = false;
            
            cancelEditBtn.classList.add('hidden');
            currentImageStatus.classList.add('hidden');
            imageHelpText.classList.remove('hidden');
        }

        // 수정 취소 버튼 이벤트
        cancelEditBtn.addEventListener('click', (e) => {
            e.preventDefault();
            resetForm();
        });

        // 전역 함수: 수정 모드 시작
        window.startEdit = (id) => {
            const data = loadedPosts[id];
            if (!data) return alert('데이터를 찾을 수 없습니다.');

            isEditing = true;
            currentEditId = id;
            currentOriginalImage = data.imageUrl;

            // 폼에 값 채우기
            document.getElementById('title').value = data.title;
            document.getElementById('category').value = data.category;
            document.getElementById('date').value = data.date;
            document.getElementById('mainImageFile').value = ''; // 파일 입력은 초기화

            // 에디터 내용 채우기
            quill.clipboard.dangerouslyPasteHTML(data.content);

            // UI 변경
            formTitle.innerText = '소식 수정하기';
            submitBtn.innerText = '수정 완료';
            submitBtn.classList.replace('bg-green-600', 'bg-blue-600');
            submitBtn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
            
            cancelEditBtn.classList.remove('hidden');
            
            if (data.imageUrl) {
                currentImageStatus.classList.remove('hidden');
                imageHelpText.classList.add('hidden');
            } else {
                currentImageStatus.classList.add('hidden');
                imageHelpText.classList.remove('hidden');
            }

            // 상단으로 스크롤
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // 2. 글 목록 불러오기
        function loadNews() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'news');
            
            onSnapshot(q, (snapshot) => {
                newsList.innerHTML = '';
                loadedPosts = {}; // 초기화

                const posts = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    posts.push({ id: doc.id, ...data });
                    loadedPosts[doc.id] = data; // 수정을 위해 데이터 저장
                });

                posts.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (posts.length === 0) {
                    newsList.innerHTML = '<div class="text-center py-10 text-gray-400">등록된 소식이 없습니다.</div>';
                    return;
                }

                const catMap = {
                    'notice': '공지사항', 'market': '중랑마을,장(場)', 'network': '네트워크 및 연대',
                    'operation': '위탁운영', 'support': '활동가 지원'
                };

                posts.forEach(post => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center';
                    
                    const thumbSrc = post.imageUrl ? post.imageUrl : 'https://via.placeholder.com/64?text=No+Img';

                    item.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <img src="${thumbSrc}" class="w-16 h-16 object-cover rounded-md bg-gray-100 border border-gray-100">
                            <div>
                                <div class="text-xs text-green-600 font-bold mb-1">${catMap[post.category] || post.category}</div>
                                <h3 class="font-bold text-gray-800 line-clamp-1">${post.title}</h3>
                                <p class="text-xs text-gray-500">${post.date}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="px-3 py-1 bg-blue-50 text-blue-600 rounded-md hover:bg-blue-100 transition text-sm font-bold border border-blue-200" onclick="startEdit('${post.id}')">
                                수정
                            </button>
                            <button class="delete-btn px-3 py-1 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition text-sm font-bold border border-red-200" data-id="${post.id}">
                                삭제
                            </button>
                        </div>
                    `;
                    newsList.appendChild(item);
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        if(confirm('정말 삭제하시겠습니까?')) {
                            const id = e.target.getAttribute('data-id');
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'news', id));
                            if (currentEditId === id) resetForm(); // 수정 중이던 글을 삭제하면 폼 초기화
                        }
                    });
                });
            });
        }
    </script>
</body>
</html>
