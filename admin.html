<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중랑마을넷 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="max-w-4xl mx-auto px-4 py-12">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">중랑마을넷 소식 관리</h1>
            <a href="index.html" class="text-green-600 hover:text-green-700 font-bold">홈페이지로 이동 <i class="fas fa-arrow-right"></i></a>
        </div>

        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        주의: 이 페이지는 누구나 접속할 수 있습니다. 실제 운영 시에는 Firebase Authentication에서 '이메일 로그인' 등을 설정하여 관리자만 접속하도록 보안을 강화해야 합니다.
                    </p>
                </div>
            </div>
        </div>

        <!-- 글 작성 폼 -->
        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 mb-12">
            <h2 class="text-xl font-bold mb-6 border-b pb-2">새 소식 작성</h2>
            <form id="newsForm" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">카테고리</label>
                        <select id="category" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="notice">공지사항</option>
                            <option value="connection">공동체 연결</option>
                            <option value="agenda">정책/의제</option>
                            <option value="education">교육/컨설팅</option>
                            <option value="operation">위탁운영</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">날짜</label>
                        <input type="date" id="date" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">제목</label>
                    <input type="text" id="title" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="소식 제목을 입력하세요" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">이미지 주소 (URL)</label>
                    <input type="url" id="imageUrl" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="https://..." required>
                    <p class="text-xs text-gray-400 mt-1">* 이미지 링크 주소를 입력해주세요. (예: unsplash 이미지 주소)</p>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">본문 내용</label>
                    <textarea id="content" rows="5" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="내용을 입력하세요" required></textarea>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">등록하기</button>
            </form>
        </div>

        <!-- 작성된 글 목록 -->
        <h2 class="text-xl font-bold mb-4">등록된 소식 목록</h2>
        <div id="admin-news-list" class="space-y-4">
            <div class="text-center py-10 text-gray-500">데이터를 불러오는 중...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        
        // [중요] GitHub Pages 등 외부 호스팅 사용 시 아래 else 블록에 본인의 Firebase 키를 입력해야 합니다.
        if (typeof __firebase_config !== 'undefined') {
            // 1. Canvas 환경 (자동 설정)
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // 2. GitHub / 실서버 환경 (직접 설정 필요)
            // Firebase 콘솔 -> 프로젝트 설정 -> 내 앱 -> SDK 설정 및 구성 에서 복사
            firebaseConfig = {
                apiKey: "AIzaSyAlGFAgrJLCz1Xno3lDwRaTONPhsXBujOM",
                authDomain: "jrmaeulnet-5021b.firebaseapp.com",
                projectId: "jrmaeulnet-5021b",
                storageBucket: "jrmaeulnet-5021b.firebasestorage.app",
                messagingSenderId: "G-81GTM29VF7",
                appId: "1:48501741158:web:37131a2bb6b02137bd7fa7"
            };
        }

        // 앱 ID 설정 (Canvas는 자동, 외부는 고정값)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'jungnang-maeul-net';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Auth Logic
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        const newsForm = document.getElementById('newsForm');
        const newsList = document.getElementById('admin-news-list');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Logged in as:", user.uid);
                loadNews();
            }
        });

        // 1. 글 등록
        newsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return alert('로그인이 필요합니다.');

            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const date = document.getElementById('date').value;
            const imageUrl = document.getElementById('imageUrl').value;
            const content = document.getElementById('content').value;

            try {
                // 컬렉션 경로 통일: Canvas 환경과 호환되면서도 GitHub에서도 동작하도록 설정
                // 실제 배포 시에는 보안 규칙(Firestore Rules) 설정이 필요할 수 있습니다.
                // 편의상 Canvas 규칙(artifacts/...)을 따르되, GitHub에서는 동작 방식에 따라 경로 조정이 필요할 수 있음.
                // 여기서는 Canvas 테스트를 위해 Canvas 경로 사용.
                // GitHub 배포시에는 db root collection을 사용할 수도 있으나, 
                // Canvas 테스트와 호환성을 위해 아래 경로 유지.
                // (GitHub 배포 시 보안 규칙에서 이 경로를 허용해줘야 함)
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'news'), {
                    title, category, date, imageUrl, content,
                    createdAt: new Date().toISOString()
                });
                alert('소식이 등록되었습니다!');
                newsForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                alert('등록 실패! Firebase 설정을 확인하세요.');
            }
        });

        // 2. 글 목록 불러오기
        function loadNews() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'news');
            
            onSnapshot(q, (snapshot) => {
                newsList.innerHTML = '';
                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });

                // 날짜 내림차순 정렬
                posts.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (posts.length === 0) {
                    newsList.innerHTML = '<div class="text-center py-10 text-gray-400">등록된 소식이 없습니다.</div>';
                    return;
                }

                posts.forEach(post => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center';
                    
                    const catMap = {
                        'notice': '공지사항', 'connection': '공동체 연결', 'agenda': '정책/의제',
                        'education': '교육/컨설팅', 'operation': '위탁운영'
                    };

                    item.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <img src="${post.imageUrl}" class="w-16 h-16 object-cover rounded-md bg-gray-200" onerror="this.src='https://via.placeholder.com/64'">
                            <div>
                                <div class="text-xs text-green-600 font-bold mb-1">${catMap[post.category] || post.category}</div>
                                <h3 class="font-bold text-gray-800">${post.title}</h3>
                                <p class="text-xs text-gray-500">${post.date}</p>
                            </div>
                        </div>
                        <button class="delete-btn px-3 py-1 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition text-sm font-bold" data-id="${post.id}">
                            삭제
                        </button>
                    `;
                    newsList.appendChild(item);
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        if(confirm('정말 삭제하시겠습니까?')) {
                            const id = e.target.getAttribute('data-id');
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'news', id));
                        }
                    });
                });
            }, (error) => {
                console.error("Error getting documents: ", error);
            });
        }
    </script>
</body>
</html>
